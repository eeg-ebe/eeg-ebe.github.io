<!Doctype html public>
<html>
    <head>
        <meta charset="UTF-8">
        <link rel="shortcut icon" type="image/png" href="images/favicon.svg"/>
        <title>HaplowebMaker</title>
        <link rel="stylesheet" href="main.css"/>
        <link rel="stylesheet" href="external/jquery-ui.min.css"/>
        <script src="external/jquery.js"></script>
        <script src="external/jquery-ui.min.js"></script>
        <script src="scripts/util.js"></script>
        <script src="scripts/MJAlgo.js"></script>
        <script>
            // load shortcuts
            shortcuts = {};
            $.getJSON("shortcuts.json", function(data) {
                shortcuts = data;
            });
            // load the available languages
            loadLanguages();
            // parse the uri
            urlParams = parseUrl();
            // check in which language the site should get displayed;
            language = 'en'; // fallback: english
            var browserLang = navigator.browserLanguage || navigator.language; // check if the language of the browser is among the supported languages => if yes, use it
            browserLang = browserLang.split("-")[0].toLowerCase();
            if(typeof languageDicts[browserLang] != "undefined") {
                language = browserLang;
            }
            if(typeof urlParams["lang"] != "undefined") { // uri parameter overwrites fallback language
                if(typeof languageDicts[urlParams["lang"]] != "undefined") {
                    // ok, a language parameter was given via uri -> use this language instead
                    language = urlParams["lang"].toLowerCase();
                } else {
                    console.log("WARNING: language '" + urlParams['lang'] + "' not found!");
                }
            }
            // create a new empty project
            project = {
                "projectName" : null,
                "markers" : []
            };
        </script>
    </head>
    <body>
        <a name="top"></a>
        <div id="calculationOverlay" class="ui-widget-overlay ui-front" style="z-index: 100">
            <div class="centerEverythingWrapper">
                <img src="images/loading.gif" style="z-index:105"/>
            </div>
        </div>
        <div id="banner">
            <div style="padding: 10">
                <a id="mainToolsOpener" class="tooltip shortcut" shortcut="openMainToolsToolbox" tid="openMainToolsToolbox.title" onclick="javascript: $('#mainToolsToolbox').toggle();">
                    <img id="logoImg" src="images/logo.svg" />
                    <span style="vertical-align: middle; height: 40; font: italic 32px Verdana; text-decoration: none; color: lightgray;">&nbsp;HaplowebMaker</span>
                </a>
            </div>
        </div>
        <div id="bannerSpace"></div>
        <ul id="mainToolsToolbox" class="ui-border-all">
            <li>
                <div class="shortcut" shortcut="newInstance" onclick="javascript: openNewInstance();">
                    <span class="ui-icon ui-icon-plus"></span><span class="label tooltip" lid="newInstance.label" tid="newInstance.title"></span>
                </div>
            </li>
            <li>
                <div class="shortcut" shortcut="loadProject" onclick="javascript: loadProject();">
                    <span class="ui-icon ui-icon-folder-open"></span><span class="label tooltip" lid="loadProject.label" tid="loadProject.title"></span>
                </div>
            </li>
            <li>
                <div class="shortcut" shortcut="saveProject" onclick="javascript: saveProject();">
                    <span class="ui-icon ui-icon-disk"></span><span class="label tooltip" lid="saveProject.label" tid="saveProject.title"></span>
                </div>
            </li>
            <li>
                <div>
                    <span class="ui-icon ui-icon-arrow-4-diag"></span>
                    <span class="label tooltip" lid="navigation.label" tid="navigation.title"></span>
                </div>
                <ul>
                    <li>
                        <div class="shortcut" shortcut="scrollUp" onclick="javascript: scrollUp();">
                            <span class="ui-icon ui-icon-arrowstop-1-n"></span><span class="label tooltip" lid="scrollUp.label" tid="scrollUp.title"></span>
                        </div>
                    </li>
                    <li>
                        <div class="shortcut" shortcut="scrollDown" onclick="javascript: scrollDown();">
                            <span class="ui-icon ui-icon-arrowstop-1-s"></span><span class="label tooltip" lid="scrollDown.label" tid="scrollDown.title"></span>
                        </div>
                    </li>
                </ul>
            </li>
            <li>
                <div>
                    <span class="ui-icon ui-icon-comment"></span>
                    <span class="label tooltip" lid="language.label" tid="language.title"></span>
                </div>
                <ul>
                    <script>
                        for(key in languageDicts) {
                            document.write("<li><div onclick=\"javascript: setLanguage('" + key + "');\"><span class=\"ui-icon imgInSpan\" style=\"background-image:url('languages/" + languageDicts[key]["flag_path"] + "')\"></span>" + languageDicts[key]["lang_long"] + "</div></li>");
                        }
                    </script>
                </ul>
            </li>
            <li>
                <div>
                    <span class="ui-icon ui-icon-note"></span>
                    <span class="label tooltip" lid="documentation.label" tid="documentation.title"></span>
                </div>
                <ul>
                    <!-- TODO: documentation-->
                    <li>
                        <div class="shortcut" shortcut="cite" onclick="javascript: showCite();">
                            <span class="ui-icon ui-icon-star"></span>
                            <span class="label tooltip" lid="cite.label" tid="cite.title"></span>
                        </div>
                    </li>
                    <li>
                        <div class="shortcut" shortcut="contact" onclick="javascript: window.location='mailto: Yann SpÃ¶ri <ga29qal@mytum.de>'">
                            <span class="ui-icon ui-icon-contact"></span>
                            <span class="label tooltip" lid="contact.label" tid="contact.title"></span>
                        </div>
                    </li>
                    <li>
                        <div class="shortcut" shortcut="usedSoftware" onclick="javascript: showUsedSoftware();">
                            <span class="ui-icon ui-icon-link"></span>
                            <span class="label tooltip" lid="usedSoftware.label" tid="usedSoftware.title"></span>
                        </div>
                    </li>
                </div>
                </ul>
            </li>            
            <li>
                <div class="shortcut" shortcut="configureShortcuts" onclick="javascript: configureShortcuts();">
                    <span class="ui-icon ui-icon-gear"></span><span class="label tooltip" lid="configureShortcuts.label" tid="configureShortcuts.title"></span>
                </div>
            </li>
        </ul>
        <a href="https://github.com/eeg-ebe/eeg-ebe.github.io">
            <img style="z-index: 25; position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/e7bbb0521b397edbd5fe43e7f760759336b5e05f/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f677265656e5f3030373230302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_green_007200.png">
        </a>

        <!-- Main content start -->

        <div id="submitNewSequencesDiv" class="centerEverythingWrapper" style="width: 50.0%;">
            <img src="images/bg.svg"/>
            <table id="jobSubmissionTable" class="ui-corner-all">
                <tr class="tooltip" tid="jobSubmissionJobName.title">
                    <td class="label" lid="jobSubmissionJobName.label"></td>
                    <td style="text-align: right"><input type="text" id="jobname" name="jobname" /></td>
                </tr>
                <tr class="tooltip" tid="jobSubmissionFasta.title"">
                    <td class="label" lid="jobSubmissionFasta.label"></td>
                    <td style="text-align: right"><input type="file" id="faAlign" name="faAlign" multiple="" /></td>
                </tr>
                <tr>
                    <td onclick="javascript: $('.advancedSettings').toggle(); $('#advancedSettingsIcon').toggleClass('ui-icon-triangle-1-e ui-icon-triangle-1-s');" style="cursor:pointer"><span id="advancedSettingsIcon" class="ui-icon ui-icon-triangle-1-e"></span><span class="label" lid="jobSubmissionAdvancedSettings.label">Erweiterete Einstellungen</span></td>
                    <td></td>
                </tr>
                <tr class="advancedSettings tooltip" tid="jobSubmissionAdvancedSettingsMJFasta.title">
                    <td class="label" lid="jobSubmissionAdvancedSettingsMJFasta.label"></td>
                    <td style="text-align: right"><input type="checkbox" name="ignoreUpperLower" id="ignoreUpperLower" checked="cheched"></td>
                </tr>
                <tr class="advancedSettings tooltip" tid="jobSubmissionAdvancedSettingsMJEpsilon.title">
                    <td class="label" lid="jobSubmissionAdvancedSettingsMJEpsilon.label"></td>
                    <td style="text-align: right"><input id="epsilon" name="value" value="0"><script>$("#epsilon").spinner()</script></td>
                </tr>
                <tr>
                    <td></td>
                    <td style="text-align: right"><button id="jobSubmissionButton" class="ui-button ui-widget ui-corner-all shortcut label tooltip" shortcut="jobsubmission" lid="jobSubmissionButton.label" tid="jobSubmissionButton.title" onclick="javascript: addNewSequencesToProject();"></button></td>
                </tr>
            </table>
            <div style="font-size: 75%; padding: 5px">
                <span class="label" lid="jobSubmissionJobNameExp.label"></span><br/>
                <span class="label" lid="jobSubmissionFastaExp.label"></span> [<a class="label" lid="exemplaryFastaFileDownloadLink.label" href="examples.zip"></a>]
            </div>
        </div>

        <!-- Main content end -->

        <div id="genericInfoDialog">
            <p>
                <span class="ui-icon ui-icon-info" style="float:left;margin:0 7px 0 0;"></span>
                <div id="genericInfoDialogContent" style="margin:0 0 0 23px"></div>
            </p>
        </div>
        <div id="shortcutConfigurationWarningDialog">
            <p>
                <span class="ui-icon ui-icon-alert" style="float:left;margin:0 7px 50px 0;"></span>
                <span id="shortcutConfigurationWarningDialogText" class='label' lid='shortcutConfigurationWarningDialogText.label' la0='' la1='' la2=''></span>
            </p>
        </div>
        <div id="shortcutConfigurationDialog" class="tooltip" tid="configureShortcuts.dialog.label">
            <p style="margin-bottom: 5px;">
                <input id='availableActionsAutoComplete' class="searchField" autocomplete="off" />
                <button class="ui-button ui-widget ui-corner-all" style="float:right;" onclick="javascript: downloadShortcuts()">
                    <span class="ui-icon ui-icon-disk"></span><span class="label" lid="buttonDownload"></span>
                </button>
                <input type="file" id="uploadShortcutsFileField" onchange="javascript: uploadShortcuts();" autocomplete="off" style="float:right;" />
            </p>
            <div id="shortcutConfigurationDialogContent"></div>
        </div>
        <div id="invisibleHelperObjects">
            <a id="newInstanceLink" target="_blank"></a>
            <a id="scrollUpLink" href="#top"></a>
            <a id="scrollDownLink" href="#bottom"></a>
            <script>
                function showCite() {
                    $("#calculationOverlay").show();
                    $.getJSON("cite.json", function(data) {
                        var dialog = $("#genericInfoDialog");
                        dialog.dialog('option', 'title', languageDicts[language]["dict"]["cite.label"]);
                        var html = "";
                        for(var id=0; id < data.length; id++) {
                            var paper = data[id];
                            html += "<div style='margin-bottom: 7px'><span class='ui-icon ui-icon-triangle-1-e'></span>" + paper["ref"] + " [<a href='" + paper["link"] + "'>Link</a>]</div>";
                        }
                        $("#genericInfoDialogContent").html(html);
                        dialog.dialog("open");
                        $("#calculationOverlay").hide();
                    });
                }
                function showUsedSoftware() {
                    $("#calculationOverlay").show();
                    $.getJSON("usedSoftware.json", function(data) {
                        var dialog = $("#genericInfoDialog");
                        dialog.dialog('option', 'title', languageDicts[language]["dict"]["usedSoftware.label"]);
                        var html = "";
                        for(var id=0; id < data.length; id++) {
                            var soft = data[id];
                            html += "<div style='margin-bottom: 7px'><span class='ui-icon ui-icon-triangle-1-e'></span><b>" + soft["name"] + "</b><span style='float:right'>[<a href='" + soft["license"] + "'>License</a>]</span><br>";
                            for(uid in soft["urls"]) {
                                var url = soft["urls"][uid];
                                html += "<a href='" + url + "'>" + url + "</a><br>";
                            }
                            html += "</div>";
                        }
                        $("#genericInfoDialogContent").html(html);
                        dialog.dialog("open");
                        $("#calculationOverlay").hide();
                    });
                }
                function openNewInstance() {
                    $("#newInstanceLink").attr("href", "index.html?lang=" + language);
                    document.getElementById("newInstanceLink").click();
                }
                function scrollUp() {
                    document.getElementById("scrollUpLink").click();
                }
                function scrollDown() {
                    document.getElementById("scrollDownLink").click();
                }
                function configureShortcuts() {
                    $( "#shortcutConfigurationDialog" ).dialog("open");
                }
                function getNewShortcuts() {
                    var result = {};
                    result["actions"] = shortcuts["actions"];
                    for(var actionNr=0; actionNr < shortcuts["actions"].length; actionNr++) {
                        var action = shortcuts["actions"][actionNr];
                        var shortcut = document.getElementById("shortcut" + action + "edit").value;
                        if(shortcut != "-") {
                            if(typeof result["_" + shortcut] === "undefined") {
                                result["_" + shortcut] = action;
                            } else {
                                console.log("WARNING: Duplicated shortcut: '_" + shortcut + "'!");
                                var diag = $( "#shortcutConfigurationWarningDialog" );
                                diag.dialog('option', 'title', languageDicts[language]["dict"]["configureShortcuts.warningdialog.label"]);
                                var ele = $("#shortcutConfigurationWarningDialogText");
                                ele.attr("la0", languageDicts[language]["dict"][action + ".label"]);
                                ele.attr("la1", languageDicts[language]["dict"][result["_" + shortcut] + ".label"]);
                                ele.attr("la2", shortcut);
                                $(".dialogOkButton").text(languageDicts[language]["dict"]["buttonOk"]);
                                setLanguage(language);
                                diag.dialog( "open" );
                                return null;
                            }
                        }
                    }
                    return result;
                }
                function downloadShortcuts() {
                    var newShortcuts = getNewShortcuts();
                    if(newShortcuts != null) {
                        var b64 = window.btoa(JSON.stringify(newShortcuts));
                        $("body").append($("<a id='downloadLink' href-lang='application/json' href='data:application/json;base64,\n"+b64+"' title='shortcuts.dat' style='display:none' download='shortcuts.dat'>Download</a>"));
                        document.getElementById('downloadLink').click();
                        $("#downloadLink").remove();
                    }
                }
                function uploadShortcuts() {
                    console.log("INFO: Uploading new shortcuts!");
                    reader = new FileReader();
                    var files = files = document.getElementById('uploadShortcutsFileField').files;
                    for (var i = 0, f; f = files[i]; i++) {
                        reader.onload = function(data) {
                            console.log("INFO: shortcut data: " + data.target.result);
                            shortcuts = JSON.parse(data.target.result);
                            $( "#shortcutConfigurationDialog" ).dialog("close");
                        };
                        reader.readAsText(f);
                    }
                }
                function addNewSequencesToProject() {
                    // show the calculation panel
                    $("#calculationOverlay").show();
                    // check the data that was given!
                    project["projectName"] = document.getElementById("jobname").value;
                    
console.log(jobName);
//                    $("#submitNewSequencesDiv").hide();
                    // TODO
                }
                function loadProject() { console.log("loading"); } // TODO
                function saveProject() { console.log("save"); } // TODO
            </script>
        </div>
        <a name="bottom"></a>
        <script>
            // complete DOM loaded? Then set the DOM's text
            setLanguage(language);
            // tooltip & other jquery-ui objects
            $( document ).tooltip();
            $( '#mainToolsToolbox' ).menu();
            $( "#shortcutConfigurationWarningDialog" ).dialog({
                modal: true,
                autoOpen: false,
                buttons: [{
                    "text" : languageDicts[language]["dict"]["buttonOk"],
                    "class" : "dialogOkButton",
                    "click" : function() {
                        $( this ).dialog( "close" );
                    }
                }],
                open: function() {
                    $(".dialogOkButton").text(languageDicts[language]["dict"]["buttonOk"]);
                },
                hide: {
                    effect: "explode",
                    duration: 1000
                }
            });
            $( "#genericInfoDialog" ).dialog({
                modal: true,
                autoOpen: false,
                height: 400,
                width: 750,
                buttons: [{
                    "text" : languageDicts[language]["dict"]["buttonOk"],
                    "class" : "dialogOkButton",
                    "click" : function() {
                        $( this ).dialog( "close" );
                    }
                }],
                open: function() {
                    $(".dialogOkButton").text(languageDicts[language]["dict"]["buttonOk"]);
                },
                hide: {
                    effect: "explode",
                    duration: 1000
                }
            });
            $( "#shortcutConfigurationDialog" ).dialog({
                autoOpen: false,
                height: 400,
                width: 750,
                modal: true,
                open: function() {
                    // set text
                    $(this).dialog('option', 'title', languageDicts[language]["dict"]["configureShortcuts.label"]);
                    $(".dialogSaveButton").text(languageDicts[language]["dict"]["buttonSave"]);
                    $(".dialogCancelButton").text(languageDicts[language]["dict"]["buttonCancel"]);
                    $("#availableActionsAutoComplete").attr("placeholder", languageDicts[language]["dict"]["searchbarplaceholdertext"]);
                    // set content
                    var html = "<table class='dataContentTable'><tr class='header'><td class='label left' lid='shortcutAction.label'></td><td class='label right' lid='shortcutValue.label'></td></tr>";
                    var counter = 0;
                    var availableActions = new Array();
                    for(var actionNr=0; actionNr < shortcuts["actions"].length; actionNr++) {
                        var action = shortcuts["actions"][actionNr];
                        availableActions.push(action);
                        html += "<tr id='shortcut" + action + "tr' class='" + ((counter % 2 == 0) ? "even" : "odd") +"'><td><a name='shortcut" + action + "anchor'></a><span class='label' lid='" + action + ".label'></span></td><td align='right'><input id='shortcut" + action + "edit' type='text' value='-' style='text-align: right;'></td></tr>";
                        counter++;
                    }
                    html += "</table>";
                    $("#shortcutConfigurationDialogContent").html(html);
                    for(key in shortcuts) {
                        if(key.startsWith("_")) {
                            var value = shortcuts[key];
                            key = key.substr(1);
                            var ele = document.getElementById("shortcut" + value + "edit");
                            if(ele != null) {
                                ele.value = key;
                                $(ele).attr("placeholder", key);
                                counter++;
                            }
                        }
                    }
                    // damn autocomplete
                    var control = $( "#availableActionsAutoComplete" );
                    control.autocomplete({
                        source: availableActions,
                        select: function(event, ui) {
                            jump("shortcut" + ui.item.value + "anchor");
                            javascript:$("#shortcut" + ui.item.value + "tr").effect('highlight', {color: 'red'}, 1750);
                        }
                    });
                    control.focus(function(){$(this).val('');});
                    setLanguage(language);
                },
                buttons: [{
                        "text" : languageDicts[language]["dict"]["buttonSave"],
                        "class" : "dialogSaveButton",
                        "click" : function() {
                            var newShortcuts = getNewShortcuts();
                            if(newShortcuts != null) {
                                shortcuts = newShortcuts;
                                $( "#shortcutConfigurationDialog" ).dialog("close");
                            }
                        }
                    }, {
                        "text" : languageDicts[language]["dict"]["buttonCancel"],
                        "class" : "dialogCancelButton",
                        "click" : function() {
                            $( "#shortcutConfigurationDialog" ).dialog("close");
                        }
                    }
                ],
                hide: {
                    effect: "explode",
                    duration: 1000
                }
            });
            // do shortcut handling
            $("body").keydown(function(event) {
                var fobj = $(':focus');
                if(!fobj.is("input") && !fobj.is("textarea")) {
                    var mod = "_";
                    if(event.ctrlKey)  mod = mod + "c";
                    if(event.altKey)   mod = mod + "a";
                    if(event.shiftKey) mod = mod + "s";
                    mod = mod + event.keyCode;
                    console.log("INFO: pressed '" + mod + "'!");
                    if(typeof shortcuts[mod] != "undefined") {
                        console.log("INFO: exec '" + shortcuts[mod] + "'!");
                        handleEvent(shortcuts[mod]);
                        event.preventDefault();
                    }
                }
            });
            // everything done -> remove overlay
            $("#calculationOverlay").hide();
        </script>
    </body>
</html>
