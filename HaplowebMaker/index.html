<!Doctype html public>
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="referrer" content="no-referrer" />
        <link rel="shortcut icon" type="image/png" href="images/favicon.svg"/>
        <title>HaplowebMaker</title>
        <link rel="stylesheet" href="main.css"/>
        <link rel="stylesheet" href="external/jquery-ui.min.css"/>
<!--
        <script>
            window.onerror = function(msg, url, line, col, error) {
                var extra = !col ? '' : '\ncolumn: ' + col;
                extra += !error ? '' : '\nerror: ' + error;
                extra += !navigator.userAgent ? '' : "\nUserAgent: " + navigator.userAgent;
                alert("Ooops, this should not happen!\n\nAn unexpected error occured!\nPlease report the following information to the authors of this program, so that this error can get fixed:\n\nError: " + msg + "\nurl: " + url + "\nline: " + line + extra);
            }
        </script>
-->
        <script src="external/FileSaver.min.js"></script>
        <script src="external/jquery.js"></script>
        <script src="external/moment.min.js"></script>
        <script src="external/jquery-ui.min.js"></script>
        <script src="external/jszip.js"></script>
        <script src="scripts/util.js"></script>
        <script src="scripts/LstExtractor.js"></script>
        <script src="scripts/Drawing.js"></script>
        <script>
            // load shortcuts
            shortcuts = {};
            $.getJSON("shortcuts.json", function(data) {
                shortcuts = data;
            });
            // load the available languages
            loadLanguages();
            // parse the uri
            urlParams = parseUrl();
            // check in which language the site should get displayed;
            language = 'en'; // fallback: english
            var browserLang = navigator.browserLanguage || navigator.language; // check if the language of the browser is among the supported languages => if yes, use it
            browserLang = browserLang.split("-")[0].toLowerCase();
            if(typeof languageDicts[browserLang] != "undefined") {
                language = browserLang;
            }
            if(typeof urlParams["lang"] != "undefined") { // uri parameter overwrites fallback language
                if(typeof languageDicts[urlParams["lang"]] != "undefined") {
                    // ok, a language parameter was given via uri -> use this language instead
                    language = urlParams["lang"].toLowerCase();
                } else {
                    console.log("WARNING: language '" + urlParams['lang'] + "' not found!");
                }
            }
            // create a new empty project
            project = {};
            // the worker
            worker = new Worker("scripts/worker.js");
            // some settings
            timeformat = 'YYYY-MM-DD, HH:mm:ss:SSS';
            if(typeof urlParams["timeformat"] != "undefined") {
                timeformat = urlParams["timeformat"];
            }
            colorSamePos = 'blue';
            if(typeof urlParams["colorSamePos"] != "undefined") {
                colorSamePos = urlParams["colorSamePos"];
            }
            colorDifPos = 'yellow';
            if(typeof urlParams["colorDifPos"] != "undefined") {
                colorDifPos = urlParams["colorDifPos"];
            }
        </script>
    </head>
    <body>
        <a name="top" class="anchor"></a>
        <div id="calculationOverlay" class="ui-widget-overlay ui-front">
            <div class="centerEverythingWrapper">
                <img src="images/loading.gif" class="ui-front"/>
            </div>
        </div>
        <div id="banner">
            <div style="padding: 10">
                <a id="mainToolsOpener" class="tooltip shortcut" shortcut="openMainToolsToolbox" tid="openMainToolsToolbox.title" onclick="javascript: $('#mainToolsToolbox').toggle();">
                    <img id="logoImg" src="images/logo.svg" />
                    <span style="vertical-align: middle; height: 40; font: italic 32px Verdana; text-decoration: none; color: lightgray;">&nbsp;HaplowebMaker</span>
                </a>
            </div>
        </div>
        <div id="bannerSpace"></div>
        <ul id="mainToolsToolbox" class="ui-border-all">
            <li>
                <div class="shortcut" shortcut="newInstance" onclick="javascript: openNewInstance();">
                    <span class="ui-icon ui-icon-plus"></span><span class="label tooltip" lid="newInstance.label" tid="newInstance.title"></span>
                </div>
            </li>
            <li>
                <div class="shortcut" shortcut="loadProject" onclick="javascript: loadProject();">
                    <span class="ui-icon ui-icon-folder-open"></span><span class="label tooltip" lid="loadProject.label" tid="loadProject.title"></span>
                </div>
            </li>
            <li>
                <div id="saveProjectDiv" class="shortcut ui-state-disabled" shortcut="saveProject" onclick="javascript: saveProject();">
                    <span class="ui-icon ui-icon-disk"></span><span class="label tooltip" lid="saveProject.label" tid="saveProject.title"></span>
                </div>
            </li>
            <li>
                <div>
                    <span class="ui-icon ui-icon-arrow-4-diag"></span>
                    <span class="label tooltip" lid="navigation.label" tid="navigation.title"></span>
                </div>
                <ul>
                    <li>
                        <div class="shortcut" shortcut="scrollUp" onclick="javascript: scrollUp();">
                            <span class="ui-icon ui-icon-arrowstop-1-n"></span><span class="label tooltip" lid="scrollUp.label" tid="scrollUp.title"></span>
                        </div>
                    </li>
                    <li>
                        <div class="shortcut" shortcut="scrollDown" onclick="javascript: scrollDown();">
                            <span class="ui-icon ui-icon-arrowstop-1-s"></span><span class="label tooltip" lid="scrollDown.label" tid="scrollDown.title"></span>
                        </div>
                    </li>
                </ul>
            </li>
            <li>
                <div>
                    <span class="ui-icon ui-icon-comment"></span>
                    <span class="label tooltip" lid="language.label" tid="language.title"></span>
                </div>
                <ul>
                    <script>
                        for(key in languageDicts) {
                            document.write("<li><div onclick=\"javascript: setLanguage('" + key + "');\"><span class=\"ui-icon imgInSpan\" style=\"background-image:url('languages/" + languageDicts[key]["flag_path"] + "')\"></span>" + languageDicts[key]["lang_long"] + "</div></li>");
                        }
                    </script>
                </ul>
            </li>
            <li>
                <div>
                    <span class="ui-icon ui-icon-note"></span>
                    <span class="label tooltip" lid="documentation.label" tid="documentation.title"></span>
                </div>
                <ul>
                    <!-- TODO: documentation, impressum -->
                    <li>
                        <div class="shortcut" shortcut="cite" onclick="javascript: showCite();">
                            <span class="ui-icon ui-icon-star"></span>
                            <span class="label tooltip" lid="cite.label" tid="cite.title"></span>
                        </div>
                    </li>
                    <li>
                        <div class="shortcut" shortcut="contact" onclick="javascript: window.location='mailto: Yann SpÃ¶ri <ga29qal@mytum.de>'">
                            <span class="ui-icon ui-icon-contact"></span>
                            <span class="label tooltip" lid="contact.label" tid="contact.title"></span>
                        </div>
                    </li>
                    <li>
                        <div class="shortcut" shortcut="usedSoftware" onclick="javascript: showUsedSoftware();">
                            <span class="ui-icon ui-icon-link"></span>
                            <span class="label tooltip" lid="usedSoftware.label" tid="usedSoftware.title"></span>
                        </div>
                    </li>
                </ul>
            </li>            
            <li>
                <div class="shortcut" shortcut="configureShortcuts" onclick="javascript: configureShortcuts();">
                    <span class="ui-icon ui-icon-gear"></span><span class="label tooltip" lid="configureShortcuts.label" tid="configureShortcuts.title"></span>
                </div>
            </li>
        </ul>
        <a href="https://github.com/eeg-ebe/eeg-ebe.github.io">
            <img style="z-index: 51; position: absolute; top: 0; right: 0; border: 0;" src="images/fork.png" alt="Fork me on GitHub" />
        </a>

        <!-- Main content start -->

        <div id="submitNewSequencesDiv" class="centerEverythingWrapper" style="width: 50.0%;">
            <img src="images/bg.svg"/>
            <table id="jobSubmissionTable" class="ui-corner-all">
                <tr class="tooltip" tid="jobSubmissionJobName.title">
                    <td class="label" lid="jobSubmissionJobName.label"></td>
                    <td style="text-align: right"><input type="text" id="jobname" name="jobname" autocomplete="off" /></td>
                </tr>
                <tr class="tooltip" tid="jobSubmissionFasta.title">
                    <td class="label" lid="jobSubmissionFasta.label"></td>
                    <td style="text-align: right"><input type="file" id="faAlign" name="faAlign" multiple="" autocomplete="off" /></td>
                </tr>
                <tr>
                    <td onclick="javascript: $('.advancedSettings').toggle(); $('#advancedSettingsIcon').toggleClass('ui-icon-triangle-1-e ui-icon-triangle-1-s');" style="cursor:pointer"><span id="advancedSettingsIcon" class="ui-icon ui-icon-triangle-1-e"></span><span class="label" lid="jobSubmissionAdvancedSettings.label">Erweiterete Einstellungen</span></td>
                    <td></td>
                </tr>
                <tr class="advancedSettings tooltip" tid="jobSubmissionAdvancedSettingsMJFasta.title">
                    <td class="label" lid="jobSubmissionAdvancedSettingsMJFasta.label"></td>
                    <td style="text-align: right"><input type="checkbox" name="ignoreUpperLower" id="ignoreUpperLower" checked="cheched" autocomplete="off" /></td>
                </tr>
                <tr class="advancedSettings tooltip" tid="jobSubmissionAdvancedSettingsMJEpsilon.title">
                    <td class="label" lid="jobSubmissionAdvancedSettingsMJEpsilon.label"></td>
                    <td style="text-align: right"><input id="epsilon" name="value" value="0.0" autocomplete="off" />
                        <script>
                            $("#epsilon").spinner({
                                step: 0.1,
                                spin: function( event, ui ) {
                                    if ( ui.value < 0 ) {
                                        $( this ).spinner( "value", 0.0 );
                                        return false;
                                    }
                                }
                            });
                        </script>
                    </td>
                </tr>
                <tr>
                    <td></td>
                    <td style="text-align: right"><button id="jobSubmissionButton" class="ui-button ui-widget ui-corner-all shortcut label tooltip" shortcut="jobsubmission" lid="jobSubmissionButton.label" tid="jobSubmissionButton.title" onclick="javascript: addNewSequencesToProject();"></button></td>
                </tr>
            </table>
            <div style="font-size: 75%; padding: 5px">
                <span class="label" lid="jobSubmissionJobNameExp.label"></span><br/>
                <span class="label" lid="jobSubmissionFastaExp.label"></span> [<a class="label" lid="exemplaryFastaFileDownloadLink.label" href="examples.zip"></a>]
            </div>
        </div>
        <div id="projectShowBox" style="display: none; padding: 15px">
            
        </div>

        <!-- Main content end -->

        <div id="genericInfoDialog">
            <p>
                <span class="ui-icon ui-icon-info" style="float:left;margin:0 7px 0 0;"></span>
                <div id="genericInfoDialogContent" style="margin:0 0 0 23px"></div>
            </p>
        </div>
        <div id="shortcutConfigurationWarningDialog">
            <p>
                <span class="ui-icon ui-icon-alert" style="float:left;margin:0 7px 50px 0;"></span>
                <span id="shortcutConfigurationWarningDialogText" class='label' lid='shortcutConfigurationWarningDialogText.label' la0='' la1='' la2=''></span>
            </p>
        </div>
        <div id="shortcutConfigurationDialog" class="tooltip" tid="configureShortcuts.dialog.label">
            <p style="margin-bottom: 5px;">
                <input id='availableActionsAutoComplete' class="searchField" autocomplete="off" />
                <button class="ui-button ui-widget ui-corner-all" style="float:right;" onclick="javascript: downloadShortcuts()">
                    <span class="ui-icon ui-icon-disk"></span><span class="label" lid="buttonDownload"></span>
                </button>
                <input type="file" id="uploadShortcutsFileField" onchange="javascript: uploadShortcuts();" autocomplete="off" style="float:right;" />
            </p>
            <div id="shortcutConfigurationDialogContent"></div>
        </div>
        <div id="editSVGDialog"><!-- TODO -->
            <div id="editSVGDialogDim" style="overlow:hidden">
                <div>
                    <button onclick="javascript: currentGraphEdit.drawCircles = !currentGraphEdit.drawCircles; updateSVG();">Toggle circle vis</button>
                    <button onclick="javascript: currentGraphEdit.drawCons = !currentGraphEdit.drawCons; updateSVG();">Toggle line vis</button>
                    <button onclick="javascript: currentGraphEdit.drawCurves = !currentGraphEdit.drawCurves; updateSVG();">Toggle curve vis</button>
                    <button onclick="javascript: currentGraphEdit.drawBezierPoints = !currentGraphEdit.drawBezierPoints; updateSVG();">Toggle BÃ©zier vis</button>
                    <button onclick="javascript: currentGraphEdit.drawCenter = !currentGraphEdit.drawCenter; updateSVG();">Toggle center vis</button>
                    <button onclick="javascript: currentGraphEdit.drawAngles = !currentGraphEdit.drawAngles; updateSVG();">Toggle angle vis</button>
                    <br>
                    <button onclick="javascript: currentGraphEdit.assignRandomNodePos(); updateSVG();">Random</button>
                    <button onclick="javascript: stopForce=false; currentGraphEdit.forceDirectedMethod(false, 0.6, 0.5, 500.0, 0.1, 0.1, 1, true); force();">Force</button>
                    <button onclick="javascript: stopForce=true">Stop force</button>
                    <button onclick="javascript: currentGraphEdit.stretch(9/10); updateSVG();">Stretch--</button>
                    <button onclick="javascript: var f=parseFloat(prompt('Please insert stretching factor: (float)')); currentGraphEdit.stretch(f); updateSVG();">Stretch?</button>
                    <button onclick="javascript: currentGraphEdit.stretch(10/9); updateSVG();">Stretch++</button>
                    <button onclick="javascript: exportEditSVG('image/png');">Export png</button>
                    <button onclick="javascript: exportEditSVGasSVG();">Export svg</button>
                    <button onclick="javascript: currentGraphEdit.assignLinkPos(); updateSVG();">Recalc curves</button>
                    <button onclick="javascript: currentGraphEdit.mult_radius(10/9); updateSVG();">Circles ++</button>
                    <button onclick="javascript: currentGraphEdit.mult_radius(9/10); updateSVG();">Circles --</button>
                    <br>
                    <button onclick="javascript: currentGraphEdit.rotateN90(); updateSVG();"><span class="ui-icon ui-icon-arrowreturnthick-1-s"></span></button>
                    <button onclick="javascript: var f=parseFloat(prompt('Please insert angle: (float,degree)')); if(isNaN(f)) { /*TODO*/ } else {currentGraphEdit.rotate(f / 360 * 2 * Math.PI); updateSVG();}">Rot angle</button>
                    <button onclick="javascript: currentGraphEdit.rotateP90(); updateSVG();"><span class="ui-icon ui-icon-arrowreturnthick-1-s mirror"></span></button>
                    <button onclick="javascript: currentGraphEdit.mirrorX(); updateSVG();">Mirror X</span></button>
                    <button onclick="javascript: currentGraphEdit.mirrorY(); updateSVG();">Mirror Y</span></button>
                    <br>
                    <span>Muts by lines:</span>
                    <input type="checkbox" name="drawMutsByLineChkbx" id="drawMutsByLineChkbx" autocomplete="off" />
                    <input type="color" name="drawMutsLineStrokeColor" id="drawMutsLineStrokeColor" value="#000000" autocomplete="off" />
                    <input type="text" name="drawMutsLineStrokeWidth" id="drawMutsLineStrokeWidth" value="3" autocomplete="off" />
                    <input type="text" name="drawMutsLineStrokeSize" id="drawMutsLineStrokeSize" value="10" autocomplete="off" />
                    <input type="text" name="drawMutsLineStrokeArr" id="drawMutsLineStrokeArr" value="" autocomplete="off" />
                    <button onclick="javascript: assignMutsLines();">Change</button>
                    <br>
                    <span>Muts by text:</span>
                    <input type="checkbox" name="drawMutsByTextChkbx" id="drawMutsByTextChkbx" autocomplete="off" />
                    <select name="drawMutsByTextFont" id="drawMutsByTextFont">
                        <option value="Georgia">Georgia</option>
                        <option value="Times">Times</option>
                        <option value="Palatino">Palatino</option>
                        <option value="Arial">Arial</option>
                        <option value="Impact">Impact</option>
                        <option value="Tahoma">Tahoma</option>
                        <option value="Verdana">Verdana</option>
                        <option value="Courier New">Courier New</option>
                        <option value="Lucida Console">Lucida Console</option>
                    </select>
                    <input type="text" name="drawMutsTextSize" id="drawMutsTextSize" value="20" autocomplete="off" />
                    <input type="color" name="drawMutsTextColor" id="drawMutsTextColor" value="#000000" autocomplete="off" />
                    <input type="text" name="drawMutsTextPX" id="drawMutsTextPX" value="0" autocomplete="off" />
                    <input type="text" name="drawMutsTextPY" id="drawMutsTextPY" value="0" autocomplete="off" />
                    <button onclick="javascript: assignMutsText();">Change</button>
                    <br>
                    <span>Muts by dots:</span>
                    <input type="checkbox" name="drawMutsByDotChkbx" id="drawMutsByDotChkbx" autocomplete="off" />
                    <input type="text" name="drawMutsDotSize" id="drawMutsDotSize" value="12" autocomplete="off" />
                    <input type="color" name="drawMutsDotColor" id="drawMutsDotColor" value="#000000" autocomplete="off" />
                    <input type="text" name="drawMutsDotStrokeArr" id="drawMutsDotStrokeArr" value="" autocomplete="off" />
                    <button onclick="javascript: assignMutsByDot();">Change</button>
                </div>
                <div>
                    <span id="svgDisplay" style="margin: 0; padding: 0"></span>
                </div>
            </div>
        </div>
        <div id="invisibleHelperObjects">
            <a id="newInstanceLink" target="_blank"></a>
            <a id="scrollUpLink" href="#top"></a>
            <a id="scrollDownLink" href="#bottom"></a>
            <script>
                function assignMutsByDot() {
                    var chkd = document.getElementById("drawMutsByDotChkbx").checked;
                    var size = parseFloat(document.getElementById("drawMutsDotSize").value);
                    var color = document.getElementById("drawMutsDotColor").value;
                    var arr = [];
                    var txt = document.getElementById("drawMutsDotStrokeArr").value.split(" ");
                    for(var i = 0; i < txt.length; i++) {
                        arr.push(parseFloat(txt[i]));
                    }
                    currentGraphEdit.assignButsByDots(chkd, size, color, arr);
                    updateSVG();
                }
                function assignMutsText() {
                    var chkd = document.getElementById("drawMutsByTextChkbx").checked;
                    var font = document.getElementById("drawMutsByTextFont").value;
                    var size = parseFloat(document.getElementById("drawMutsTextSize").value);
                    var color = document.getElementById("drawMutsTextColor").value;
                    var px = parseFloat(document.getElementById("drawMutsTextPX").value);
                    var py = parseFloat(document.getElementById("drawMutsTextPY").value);
                    currentGraphEdit.assignMutsText(chkd, font, size, color, px, py);
                    updateSVG();
                }
                function assignMutsLines() {
                    var chkd = document.getElementById("drawMutsByLineChkbx").checked;
                    var color = document.getElementById("drawMutsLineStrokeColor").value;
                    var width = parseFloat(document.getElementById("drawMutsLineStrokeWidth").value);
                    var size = parseFloat(document.getElementById("drawMutsLineStrokeSize").value);
                    var arr = [];
                    var txt = document.getElementById("drawMutsLineStrokeArr").value.split(" ");
                    for(var i = 0; i < txt.length; i++) {
                        arr.push(parseFloat(txt[i]));
                    }
                    currentGraphEdit.assignMutsLines(chkd, color, width, size, arr);
                    updateSVG();
                }
                function exportEditSVG(mime) {
                    // get the svg code as Blob
                    var svg = document.createElement('svg');
                    svg.innerHTML = currentGraphEdit.getSvgCode();
                    svg = svg.childNodes[0];
                    var data = (new XMLSerializer()).serializeToString(svg);
                    var svgBlob = new Blob([data], {type: 'image/svg+xml;charset=utf-8'});
                    // get the canvas
                    var myCanvas = document.createElement('canvas');
                    var myCanvasContext = myCanvas.getContext('2d');
                    myCanvas.width = svg.getAttribute("width");
                    myCanvas.height = svg.getAttribute("height");
                    // draw Blob into image
                    var DOMURL = window.URL || window.webkitURL || window;
                    var url = DOMURL.createObjectURL(svgBlob);
                    var source = new Image();
                    source.onload = function () {
                        myCanvasContext.drawImage(source, 0, 0);
                        DOMURL.revokeObjectURL(url);
                        window.open(myCanvas.toDataURL(mime), '_blank');
                    };
                    source.src = url;
                }
                function exportEditSVGasSVG() {
                    view("image/svg+xml", currentGraphEdit.getSvgCode());
                }
                function force() {
                    var tE = currentGraphEdit.forceDirectedMethod(false, 0.6, 0.5, 500.0, 0.1, 0.1, 1, false);
                    currentGraphEdit.centerPos();
                    currentGraphEdit.assignLinkPos();
                    updateSVG();
                    if(tE > 0.5 && !stopForce) {
                        window.setTimeout(force, 10);
                    }
                }
                function getClickX(event) {
                    var offset = $("#svgDisplay svg").offset();
                    var x = event.pageX - offset.left;
                    return x;
                }
                function getClickY(event) {
                    var offset = $("#svgDisplay svg").offset();
                    var y = event.pageY - offset.top;
                    return y;
                }
                function editMouseMove(event) {
                    if(selectedObj != null) {
                        selectedObj.set_xPos(initObjX + getClickX(event) - initX);
                        selectedObj.set_yPos(initObjY + getClickY(event) - initY);
                        updateSVG();
                    }
                }
                function editMouseUp(event) {
                    selectedObj = null;
                }
                function editMouseDown(event) {
                    initX = getClickX(event);
                    initY = getClickY(event);
                    selectedObj = currentGraphEdit.getNearestO(initX, initY);
                    initObjX = selectedObj.xPos;
                    initObjY = selectedObj.yPos;
                }
                function updateSVG() {
                    var svgDisp = document.getElementById("svgDisplay");
                    svgDisp.innerHTML = currentGraphEdit.getSvgCode();
                    var svg = svgDisp.childNodes[0];
                    svg.addEventListener("mousemove", editMouseMove);
                    svg.addEventListener("mouseup", editMouseUp);
                    svg.addEventListener("mousedown", editMouseDown);
                }
                function visualizeIntPos(i) {
                    var positions = project["faFiles"][i]["intPos"], seqLen = project["faFiles"][i]["seqLen"];
                    var imgWidth = seqLen * 16;
                    console.log(positions, seqLen);
                    var data = "<svg version='1.1' baseProfile='full' width='" + imgWidth + "' height='10' xmlns='http://www.w3.org/2000/svg'><rect x='0' y='0' width='" + imgWidth + "' height='10' style='fill:" + colorSamePos + "'/>";
                    var current = positions.h;
                    while(current != null && current != undefined) {
                        data += "<rect x='" + (current.item * 16) + "' y='0' width='16' height='10' fill='" + colorDifPos + "'/>";
                        current = current.next;
                    }
                    data += "</svg>";
                    showVizualization(data);
                }
                function showCite() {
                    $("#calculationOverlay").show();
                    $.getJSON("cite.json", function(data) {
                        var dialog = $("#genericInfoDialog");
                        dialog.dialog('option', 'title', languageDicts[language]["dict"]["cite.label"]);
                        var html = "";
                        for(var id=0; id < data.length; id++) {
                            var paper = data[id];
                            html += "<div style='margin-bottom: 7px'><span class='ui-icon ui-icon-triangle-1-e'></span>" + paper["ref"] + " [<a href='" + paper["link"] + "'>Link</a>]</div>";
                        }
                        $("#genericInfoDialogContent").html(html);
                        dialog.dialog("open");
                        $("#calculationOverlay").hide();
                    });
                }
                function showUsedSoftware() {
                    $("#calculationOverlay").show();
                    $.getJSON("usedSoftware.json", function(data) {
                        var dialog = $("#genericInfoDialog");
                        dialog.dialog('option', 'title', languageDicts[language]["dict"]["usedSoftware.label"]);
                        var html = "";
                        for(var id=0; id < data.length; id++) {
                            var soft = data[id];
                            html += "<div style='margin-bottom: 7px'><span class='ui-icon ui-icon-triangle-1-e'></span><b>" + soft["name"] + "</b><span style='float:right'>[<a href='" + soft["license"] + "'>License</a>]</span><br>";
                            for(uid in soft["urls"]) {
                                var url = soft["urls"][uid];
                                html += "<a href='" + url + "'>" + url + "</a><br>";
                            }
                            html += "</div>";
                        }
                        $("#genericInfoDialogContent").html(html);
                        dialog.dialog("open");
                        $("#calculationOverlay").hide();
                    });
                }
                function openNewInstance() {
                    $("#newInstanceLink").attr("href", "index.html?lang=" + language);
                    document.getElementById("newInstanceLink").click();
                }
                function scrollUp() {
                    document.getElementById("scrollUpLink").click();
                }
                function scrollDown() {
                    document.getElementById("scrollDownLink").click();
                }
                function configureShortcuts() {
                    $( "#shortcutConfigurationDialog" ).dialog("open");
                }
                function getNewShortcuts() {
                    var result = {};
                    result["actions"] = shortcuts["actions"];
                    for(var actionNr=0; actionNr < shortcuts["actions"].length; actionNr++) {
                        var action = shortcuts["actions"][actionNr];
                        var shortcut = document.getElementById("shortcut" + action + "edit").value;
                        if(shortcut != "-") {
                            if(typeof result["_" + shortcut] === "undefined") {
                                result["_" + shortcut] = action;
                            } else {
                                console.log("WARNING: Duplicated shortcut: '_" + shortcut + "'!");
                                var diag = $( "#shortcutConfigurationWarningDialog" );
                                diag.dialog('option', 'title', languageDicts[language]["dict"]["configureShortcuts.warningdialog.label"]);
                                var ele = $("#shortcutConfigurationWarningDialogText");
                                ele.attr("la0", languageDicts[language]["dict"][action + ".label"]);
                                ele.attr("la1", languageDicts[language]["dict"][result["_" + shortcut] + ".label"]);
                                ele.attr("la2", shortcut);
                                $(".dialogOkButton").text(languageDicts[language]["dict"]["buttonOk"]);
                                setLanguage(language);
                                diag.dialog( "open" );
                                return null;
                            }
                        }
                    }
                    return result;
                }
                function downloadShortcuts() {
                    var newShortcuts = getNewShortcuts();
                    if(newShortcuts != null) {
                        var b64 = window.btoa(JSON.stringify(newShortcuts));
                        $("body").append($("<a id='downloadLink' href-lang='application/json' href='data:application/json;base64,\n"+b64+"' title='shortcuts.dat' style='display:none' download='shortcuts.dat'>Download</a>"));
                        document.getElementById('downloadLink').click();
                        $("#downloadLink").remove();
                    }
                }
                function uploadShortcuts() {
                    console.log("INFO: Uploading new shortcuts!");
                    reader = new FileReader();
                    var files = document.getElementById('uploadShortcutsFileField').files;
                    for (var i = 0, f; f = files[i]; i++) {
                        reader.onload = function(data) {
                            console.log("INFO: shortcut data: " + data.target.result);
                            shortcuts = JSON.parse(data.target.result);
                            $( "#shortcutConfigurationDialog" ).dialog("close");
                        };
                        reader.readAsText(f);
                    }
                }
                function addNewSequencesToProject() {
                    // show the calculation panel
                    $("#calculationOverlay").show();
                    // get the data that was given!
                    var files = document.getElementById("faAlign").files;
                    if(files.length == 0) {
                        var dialog = $("#genericInfoDialog");
                        dialog.dialog('option', 'title', languageDicts[language]["dict"]["needAlignments.label"]);
                        $("#genericInfoDialogContent").text(languageDicts[language]["dict"]["needAlignments.text.label"]);
                        dialog.dialog("open");
                        $("#calculationOverlay").hide();
                        return;
                    }
                    project["notifications"] = [ { "ui" : "highlight", "icon" : "info", "text" : "haplowebmakerIsStillBeta.text" } ];
                    project["projectName"] = document.getElementById("jobname").value;
                    project["epsilon"] = $( "#epsilon" ).spinner( "value" );
                    project["upperLowerCase"] = document.getElementById("ignoreUpperLower").checked;
                    project["submissionDate"] = Date.now();
                    project["calculationEndDate"] = null;
                    project["browser"] = {
                        "code name" : navigator.appCodeName,
                        "browser name" : navigator.appName,
                        "version" : navigator.appVersion,
                        "browser language" : navigator.language,
                        "website language" : language,
                        "platform" : navigator.platform
                    };
                    project["faFiles"] = new Array(files.length);
                    project["progress"] = 0;
                    for (var i = 0; i < files.length; i++) {
                        var reader = new FileReader();
                        reader.file = files[i];
                        reader.fileId = i;
                        reader.onload = function(data) {
                            // add data to project
                            project["faFiles"][this.fileId] = {
                                "filename" : this.file.name,
                                "data" : data.target.result,
                                "status" : "inqueuestatus.label"
                            }
                            // check whether to call the worker
                            var toCall = true;
                            for(var i = 0; i < project["faFiles"].length; i++) {
                                if(project["faFiles"] == undefined || project["faFiles"][i] == null) {
                                    toCall = false;
                                    break;
                                }
                            }
                            // call the worker if nec.
                            if(toCall) {
                                worker.addEventListener("message", function(e) {
                                    console.log("INFO: Message from worker: ");
                                    for(var k = 0; k < e.data.length; k++) {
                                        var key = e.data[k]["key"];
                                        var val = e.data[k]["val"];
                                        console.log("INFO: +", key, val);
                                        var obj = project;
                                        for(var keyi = 0; keyi < key.length - 1; keyi++) {
                                            obj = obj[key[keyi]];
                                        }
                                        obj[key[key.length - 1]] = val;
                                    }
                                    showProject();
                                    $("#calculationOverlay").hide();
                                }, false);
                                worker.postMessage(project);
                            }
                        };
                        reader.readAsText(files[i]);
                    }
                }
                function changeProjectByUpload() {
                    console.log("INFO: Uploading project!");
                    reader = new FileReader();
                    var files = document.getElementById('projectUploadFileField').files;
                    for (var i = 0, f; f = files[i]; i++) {
                        reader.onload = function(data) {
                            console.log("INFO: project data: " + data.target.result);
                            project = JSON.parse(data.target.result);
                            $( "#genericInfoDialog" ).dialog("close");
                            showProject();
                        };
                        reader.readAsText(f);
                    }
                }
                function renameJob() {
                    var oldName = (typeof project["projectName"] === "undefined" || project["projectName"] == null || project["projectName"] == "") ? "" : project["projectName"];
                    var newName = prompt(languageDicts[language]["dict"]["askForNewJobName.label"], oldName);
                    project["projectName"] = newName;
                    showProject();
                }
                function renameAlignment(nr) {
                    var oldName = project["faFiles"][nr]["filename"];
                    var newName = prompt(languageDicts[language]["dict"]["askForNewAlignmentName.label"], oldName);
                    project["faFiles"][nr]["filename"] = newName;
                    showProject();
                }
                function loadProject() {
                    var dialog = $("#genericInfoDialog");
                    dialog.dialog('option', 'title', languageDicts[language]["dict"]["loadProject.label"]);
                    $("#genericInfoDialogContent").html("<input type='file' id='projectUploadFileField' onchange='javascript: changeProjectByUpload()'>");
                    dialog.dialog("open");
                }
                function saveProject() {
                    var projectJson = JSON.stringify(project);
                    download("application/json", "project.json", projectJson);
                }
                function showProject() {
                    if(isEmptyDict(project)) {
                        $("#projectShowBox").hide();
                        $("#saveProjectDiv").addClass("ui-state-disabled");
                        $("#jobSubmissionButton").removeClass("ui-state-disabled");
                        $("#submitNewSequencesDiv").show();
                        document.title = "HaplowebMaker";
                    } else {
                        // ok, show the project
                        // generalized content
                        $("#projectShowBox").show();
                        if(project["progress"] === 100) {  // save is only accessible if calculation finished
                            $("#saveProjectDiv").removeClass("ui-state-disabled");
                        } else {
                            $("#saveProjectDiv").addClass("ui-state-disabled");
                        }
                        $("#jobSubmissionButton").addClass("ui-state-disabled");
                        $("#submitNewSequencesDiv").hide();
                        // title ... will be set by the setLanguage function
                        // html -> jobname
                        var jobname = null;
                        if(typeof project["projectName"] === "undefined" || project["projectName"] == null || project["projectName"] == "") {
                            jobname = "<span class='label' lid='emptyProjectName'></span>";
                        } else {
                            jobname = project["projectName"].escape();
                        }
                        var html = "<div id='jobNameLine' class='tooltip' tid='jobname.title'><h1 id='jobNameH1'>" + jobname + "</h1>&nbsp;&nbsp;&nbsp;<button id='editJobNameButton' onclick='javascript:renameJob();' class='ui-button ui-widget ui-corner-all tooltip' tid='jobname.rename.title'><span class='ui-icon ui-icon-pencil'></span></button></div>";
                        // html -> notification
                        for(var i = 0; i < project["notifications"].length; i++) {
                            var not = project["notifications"][i];
                            html += generateNotification(not["ui"], not["icon"], not["text"]);
                        }
                        // html -> overview + elements
                        html += "<div id='sortable'>";
                        html += "<div class='tooltip overview ui-corner-all ui-widget ui-widget-content ui-draggable ui-resizable floater' tid='joboverview.title'><a name='overview' class='anchor'></a><div class='ui-dialog-titlebar ui-corner-all ui-widget-header ui-helper-clearfix' style='padding: 0.4em 1em; cursor: auto'><span class='ui-dialog-title'><span class='ui-icon ui-icon-home'></span> <span class='label' lid='overviewboxtitle.label'></span></span><a href='#overviewfiles' onclick=\"javascript:$('.overviewfiles').effect('highlight', {color: 'red'}, 1750);\" class='tooltip' tid='jumpToOverviewFiles.title'><span class='ui-icon ui-icon-arrowreturnthick-1-s'></span><span class='label' lid='jumpToOverviewFiles.label'></span></a></div><div id='dialog' class='ui-dialog-content ui-widget-content' style='padding: 0.4em 1em;'><table style='width:100%'><tr class='tooltip' tid='jobname.title'><td><b class='label' lid='jobname.label'></b>&nbsp;&nbsp;&nbsp;&nbsp;<button onclick='javascript:renameJob();' class='ui-button ui-widget ui-corner-all tooltip' tid='jobname.rename.title'><span class='ui-icon ui-icon-pencil'></span></button></td><td>&nbsp;&nbsp;&nbsp;</td><td id='jobnameText' class='right'>";
                        html += jobname;
                        html += "</td></tr><tr class='tooltip' tid='uploadtime.title'><td><b class='label' lid='uploadtime.label'></b></td><td></td><td class='right'>";
                        html += moment(project["submissionDate"]).format(timeformat).escape();
                        html += "</td></tr><tr class='tooltip' tid='endtime.title'><td><b class='label' lid='endtime.label'></b></td><td></td><td class='right'>";
                        html += (project["calculationEndDate"] == null) ? "<span class='label' lid='unknown'></span>" : moment(project["calculationEndDate"]).format(timeformat).escape();
                        html += "</td></tr><tr class='tooltip' tid='nrUploadedFiles.title'><td><b class='label' lid='nrUploadedFiles.label'></b></td><td></td><td class='right'>";
                        html += project["faFiles"].length;
                        html += "</td></tr><tr class='tooltip' tid='jobcalculationProcess.title'><td><b class='label' lid='jobcalculationProcess.label'></b></td><td></td><td class='right'>";
                        if(project["progress"] === 100) {
                            html += "<span class='label' lid='jobcalculationProcess.finished.label'></span>";
                        } else {
                            html += "<div id='progressbar' style='position: relative'><div id='progressbarLabel'><span>" + project["progress"] + "%</span></div></div>";
                        }
//epsilon, browser info, description, upperLowerCase
                        html += "</td></tr></table></div></div>";
                        for(var i = 0; i < project["faFiles"].length; i++) {
                            var name = project["faFiles"][i]["filename"].escape();
                            var status = project["faFiles"][i]["status"];
                            html += "<div class='alig";
                            html += i;
                            html += " ui-corner-all ui-widget ui-widget-content ui-draggable ui-resizable floater tooltip' tid='fileContentView.title' ta0='";
                            html += name;
                            html += "'><a name='alig";
                            html += i;
                            html += "' class='anchor'></a><div class='ui-dialog-titlebar ui-corner-all ui-widget-header ui-helper-clearfix' style='padding: 0.4em 1em; font-size: 125%; cursor: auto'><span class='ui-dialog-title'><span class='ui-icon ui-icon-script'></span> ";
                            html += name;
                            html += "</span><a href='#alig";
                            html += i;
                            html += "files' onclick=\"javascript:$('.alig";
                            html += i;
                            html += "files').effect('highlight', {color: 'red'}, 1750);\" class='tooltip' tid='jumpAssociatedAlignmentFiles.title'><span class='ui-icon ui-icon-arrowreturnthick-1-s'></span><span class='label' lid='jumpToAlignementFiles.label'></span></a></div><div id='dialog' class='ui-dialog-content ui-widget-content' style='padding: 0.4em 1em;'><table style='width:100%'><tr class='tooltip' tid='overviewboxesfilename.title'><td><b class='label' lid='overviewboxesfilename.label'></b>&nbsp;&nbsp;&nbsp;&nbsp;<button onclick='javascript:renameAlignment(";
                            html += i;
                            html += ");' class='ui-button ui-widget ui-corner-all'><span class='ui-icon ui-icon-pencil'></span></button></td><td>&nbsp;&nbsp;&nbsp;</td><td id='alig%sText' class='right'>";
                            html += name;
                            html += "</td></tr><tr class='tooltip' tid='calculationstatus.title'><td><b class='label' lid='calculationstatus.label'></b></td><td></td><td class='right'>";
                            if(missing(project["faFiles"][i]["statusDescription"])) {
                                html += "<span class='label' lid='";
                                html += status;
                                html += "'></span>";
                            } else {
                                html += "<a href='#' onclick='javascript: alert(\"" + project["faFiles"][i]["statusDescription"].escape() + "\")'>";
                                html += "<span class='label' lid='";
                                html += status;
                                html += "'></span></a>";
                            }
                            html += "</td></tr><tr class='tooltip' tid='nrSequencesInFile.title'><td><b class='label' lid='nrSequencesInFile.label'></b></td><td></td><td class='right'>";
                            html += (missing(project["faFiles"][i]["nrSeqs"])) ? "<span class='label' lid='unknown'></span>" : project["faFiles"][i]["nrSeqs"];
                            html += "</td></tr><tr class='tooltip' tid='nrDifSequencesInFile.title'><td><b class='label' lid='nrDifSequencesInFile.label'></b></td><td></td><td class='right'>";
                            html += (missing(project["faFiles"][i]["nrDifSeqs"])) ? "<span class='label' lid='unknown'></span>" : project["faFiles"][i]["nrDifSeqs"];
                            html += "</td></tr><tr class='tooltip' tid='seqLen.title'><td><b class='label' lid='seqLen.label'></b></td><td></td><td class='right'>";
                            html += (missing(project["faFiles"][i]["seqLen"])) ? "<span class='label' lid='unknown'></span>" : project["faFiles"][i]["seqLen"];
                            html += "</td></tr><tr class='tooltip' tid='intPos.title'><td><b class='label' lid='intPos.label'></b>&nbsp;&nbsp;&nbsp;&nbsp;<button tid='visualize' onclick='javascript:visualizeIntPos(";
                            html += i;
                            html += ");' class='tooltip ";
                            html += (missing(project["faFiles"][i]["intPos"]) || missing(project["faFiles"][i]["seqLen"])) ? "ui-state-disabled " : "";
                            html += "ui-button ui-widget ui-corner-all'><span class='ui-icon ui-icon-image'></span></button></td><td></td><td class='right'>";
                            html += (missing(project["faFiles"][i]["intPos"])) ? "<span class='label' lid='unknown'></span>" : project["faFiles"][i]["intPos"].length;
                            html += "</td></tr><tr class='tooltip' tid='nbffrs.title'><td><b class='label' lid='nbffrs.label'></b></td><td></td><td class='right'>";
                            html += (missing(project["faFiles"][i]["ffrs"])) ? "<span class='label' lid='unknown'></span>" : project["faFiles"][i]["ffrs"];
//Size, Hash, nr. lines, nr. sequences, nr. indiv., sequence characters usage, k-mer, nr. differenciating positions, histogram of nr. seqs per ffr ..., time (start, end, used), nr. ffrs, nr. med vect, (graph attrs. like degree distribution, ...), description, sound
                            html += "</td></tr></table></div></div>";
                        }
                        html += "</div>"; // this is the end of the div with the id sortable
                        // html -> file table
                        html += "<p></p><table id='fileTable'><tr class='header'><td class='left label' lid='fileTableHeaderName.label'></td><td class='left label' lid='fileTableHeaderAction.label'></td><td class='middle label' lid='fileTableHeaderDesc.label'></td></tr>";
                        var even = true;
                        html += "<tr class='" + ((even) ? "even" : "odd") + " overviewfiles'>";
                        html += "<td class='left'><a name='overviewfiles' class='anchor'></a><a href='#overview' onclick='javascript:$(\".overview\").effect(\"highlight\", {color: \"red\"}, 1750);' class='tooltip' tid='jumpOverview.title'><span class='ui-icon ui-icon-arrowreturnthick-1-n'></span></a>";
                        html += "<span class='label' lid='allFilesZip.label'></span></td><td class='left'><button class='ui-button ui-widget ui-corner-all tooltip' tid='buttonDownload' onclick='javascript:downloadEverything();'><span class='ui-icon ui-icon-disk";
                        html += (project["progress"] === 100) ? "" : " ui-state-disabled";
                        html += "'></span></button></td><td class='middle label' lid='allFilesZipDesc.label'></td></tr>";
                        even = !even;
                        for(var i = 0; i < project["faFiles"].length; i++) {
                            var name = project["faFiles"][i]["filename"].escape();
                            html += "<tr class='" + ((even) ? "even" : "odd") + " alig" + i + "files'>";
                            html += "<td class='left'><a name='alig" + i + "files' class='anchor'></a><a href='#alig" + i +"' onclick='javascript:$(\".alig" + i + "\").effect(\"highlight\", {color: \"red\"}, 1750);' class='tooltip' tid='jumpAligOverview.title'><span class='ui-icon ui-icon-arrowreturnthick-1-n'></span></a>";
                            html += name;
                            html += "</td><td class='left'><button class='ui-button ui-widget ui-corner-all tooltip' tid='buttonView' onclick='javascript:viewAlign(" + i + ")'><span class='ui-icon ui-icon-newwin'></span></button><button class='ui-button ui-widget ui-corner-all tooltip' tid='buttonDownload' onclick='javascript:downloadAlign(" + i + ")'><span class='ui-icon ui-icon-disk'></span></button>";
                            html += "</td><td class='middle label' lid='originalFaFileDesc.label'></td></tr>";
                            even = !even;
                            html += "<tr class='" + ((even) ? "even" : "odd") + " alig" + i + "files'>";
                            html += "<td class='left'><a name='alig" + i + "files' class='anchor'></a><a href='#alig" + i +"' onclick='javascript:$(\".alig" + i + "\").effect(\"highlight\", {color: \"red\"}, 1750);' class='tooltip' tid='jumpAligOverview.title'><span class='ui-icon ui-icon-arrowreturnthick-1-n'></span></a>";
                            html += name + ".haploweb";
                            html += "</td><td class='left'><button class='ui-button ui-widget ui-corner-all tooltip" + ((missing(project["faFiles"][i]["mj"])) ? " ui-state-disabled" : "") + "' tid='buttonView' onclick='javascript:viewHaploweb(" + i + ")'><span class='ui-icon ui-icon-newwin'></span></button><button class='ui-button ui-widget ui-corner-all tooltip" + ((missing(project["faFiles"][i]["mj"])) ? " ui-state-disabled" : "") + "' tid='buttonDownload' onclick='javascript:downloadHaploweb(" + i + ")'><span class='ui-icon ui-icon-disk'></span></button>";
                            html += "</td><td class='middle label' lid='haplowebTxtFileDesc.label'></td></tr>";
                            even = !even;
                            html += "<tr class='" + ((even) ? "even" : "odd") + " alig" + i + "files'>";
                            html += "<td class='left'><a name='alig" + i + "files' class='anchor'></a><a href='#alig" + i +"' onclick='javascript:$(\".alig" + i + "\").effect(\"highlight\", {color: \"red\"}, 1750);' class='tooltip' tid='jumpAligOverview.title'><span class='ui-icon ui-icon-arrowreturnthick-1-n'></span></a>";
                            html += name + ".tsv";
                            html += "</td><td class='left'><button class='ui-button ui-widget ui-corner-all tooltip" + ((missing(project["faFiles"][i]["mj"])) ? " ui-state-disabled" : "") + "' tid='buttonView' onclick='javascript:viewFFR(" + i + ")'><span class='ui-icon ui-icon-newwin'></span></button><button class='ui-button ui-widget ui-corner-all tooltip" + ((missing(project["faFiles"][i]["mj"])) ? " ui-state-disabled" : "") + "' tid='buttonDownload' onclick='javascript:downloadFFR(" + i + ")'><span class='ui-icon ui-icon-disk'></span></button>";
                            html += "</td><td class='middle label' lid='ffrTxtFileDesc.label'></td></tr>";
                            even = !even;
                            html += "<tr class='" + ((even) ? "even" : "odd") + " alig" + i + "files'>";
                            html += "<td class='eft'><a name='alig" + i + "files' class='anchor'></a><a href='#alig" + i +"' onclick='javascript:$(\".alig" + i + "\").effect(\"highlight\", {color: \"red\"}, 1750);' class='tooltip' tid='jumpAligOverview.title'><span class='ui-icon ui-icon-arrowreturnthick-1-n'></span></a>";
                            html += name + ".svg";
                            html += "</td><td class='left'><button class='ui-button ui-widget ui-corner-all tooltip" + ((missing(project["faFiles"][i]["svg"])) ? " ui-state-disabled" : "") + "' tid='buttonView' onclick='javascript:viewSVG(" + i + ")'><span class='ui-icon ui-icon-newwin'></span></button><button class='ui-button ui-widget ui-corner-all tooltip" + ((missing(project["faFiles"][i]["svg"])) ? " ui-state-disabled" : "") + "' tid='buttonDownload' onclick='javascript:downloadSVG(" + i + ")'><span class='ui-icon ui-icon-disk'></span><button class='ui-button ui-widget ui-corner-all tooltip" + ((missing(project["faFiles"][i]["svg"]) || missing(project["faFiles"][i]["graphstyle"])) ? " ui-state-disabled" : "") + "' tid='buttonEditSvg' onclick='javascript:editSVG(" + i + ")'><span class='ui-icon ui-icon-pencil'></span></button>";
                            html += "</td><td class='middle label' lid='svgTxtFileDesc.label'></td></tr>";
                            even = !even;
                        }
                        html += "</table>"; // end file table
                        // apply html
                        $("#projectShowBox").html(html);
                        // do missing needed actions
                        setLanguage(language);
//                        $( "#sortable" ).sortable({ handle: ".ui-dialog-title" });
                        if(project["progress"] !== 100) {
                            $('#progressbar').progressbar({value:project["progress"]});
                            $('#progressbar').find('.ui-progressbar-value').addClass('activeProgressbar').removeClass('ui-widget-header');
                            $('#progressbarLabel').addClass('activeProgressbarLabel');
                            $('.actionRequiresCompletion').addClass('ui-state-disabled');
                        }
                    }
                } // TODO
                function downloadEverything() {
                    $("#calculationOverlay").show();
                    var zip = new JSZip();
                    for(var i = 0; i < project["faFiles"].length; i++) {
                        var name = project["faFiles"][i]["filename"].escapeZip();
                        zip.file(name, project["faFiles"][i]["data"]);
                        zip.file(name + ".haploweb", project["faFiles"][i]["mj"]);
                        zip.file(name + ".tsv", generateFFRListByParams(i, true, true, true, false));
                        zip.file(name + ".svg", project["faFiles"][i]["svg"]);
                    }
                    zip.generateAsync({type:"blob"}).then(function(content) { saveAs(content, "all.zip"); $("#calculationOverlay").hide(); });
                } // TODO
                function viewAlign(i) {
                    view("text/plain", project["faFiles"][i]["data"]);
                }
                function downloadAlign(i) {
                    download("application/fasta", project["faFiles"][i]["filename"], project["faFiles"][i]["data"]);
                }
                function viewHaploweb(i) {
                    view("text/plain", project["faFiles"][i]["mj"]);
                }
                function downloadHaploweb(i) {
                    download("text/haploweb", project["faFiles"][i]["filename"] + ".haploweb", project["faFiles"][i]["mj"]);
                }
                function generateFFRListByParams(i, onlyInd, sort, sortAlpha, outputSet) {
                    Printer = function () {
                        this.indent = "  ";
                        this.newline = "\n";
                        this.countingOffset = 1;
                        this.l = [];
                        this.printString = function (s) {
                            this.l.push(s);
                        };
                        this.close = function () {};
                        this.toText = function () {
                            return this.l.join("");
                        }
                    }
                    var p = new Printer();
                    LstExtractor.extract(p, project["faFiles"][i]["mj"], onlyInd, sort, sortAlpha, outputSet);
                    return p.toText();
                }
                function generateFFRList(i, f) {
                    var onlyInd=true, sort=true, sortAlpha=true, outputSet=false;
                    f(generateFFRListByParams(i, onlyInd, sort, sortAlpha, outputSet));
                } // TODO
                function viewFFR(i) {
                    generateFFRList(i, function(txt) {
                        view("text/plain", txt);
                    });
                }
                function downloadFFR(i) {
                    generateFFRList(i, function(txt) {
                        download("text/ffrs", project["faFiles"][i]["filename"] + ".tsv", txt);
                    });
                }
                function viewSVG(i) {
                    view("image/svg+xml", project["faFiles"][i]["svg"]);
                }
                function downloadSVG(i) {
                    download("text/plain", project["faFiles"][i]["filename"] + ".svg", project["faFiles"][i]["svg"]);
                }
                function editSVG(i) {
                    currentGraphEdit = new draw_Graph(parsing_MJNetParser.parseNet(project["faFiles"][i]["mj"]));
                    currentGraphEdit.loadStyle(project["faFiles"][i]["graphstyle"]);
                    editSVGId = i;
                    $( "#editSVGDialog" ).dialog("open");
                }
            </script>
        </div>
        <a name="bottom" class="anchor"></a>
        <script>
            // complete DOM loaded? Then set the DOM's text
            setLanguage(language);
            // tooltip & other jquery-ui objects
            $( document ).tooltip();
            $( '#mainToolsToolbox' ).menu();
            $( '#editSVGDialog' ).dialog({
                modal: true,
                autoOpen: false,
                width:  window.innerWidth  - 10,
                open: function() {
                    $(".dialogSaveButton").text(languageDicts[language]["dict"]["buttonSave"]);
                    $(".dialogCancelButton").text(languageDicts[language]["dict"]["buttonCancel"]);
                    var dialog = $("#editSVGDialog");
                    dialog.dialog('option', 'title', languageDicts[language]["dict"]["editSvg.title"].format([project["faFiles"][editSVGId]["filename"].escape()]));
                    updateSVG();
                    selectedObj = null;
                    dialog.dialog("open");
                    $("#editSVGDialog").dialog("option", "width",  window.innerWidth  - 10);
                    var h = Math.max(document.documentElement.clientHeight, window.innerHeight || 0); //Math.min(Math.max(document.documentElement.clientHeight, window.innerHeight || 0) - 10, $("#editSVGDialogDim").height() + 10);
                    $("#editSVGDialog").dialog("option", "height", h);
                },
                buttons: [{
                        "text" : languageDicts[language]["dict"]["buttonSave"],
                        "class" : "dialogSaveButton",
                        "click" : function() {
                            project["faFiles"][editSVGId]["graphstyle"] = currentGraphEdit.saveStyle();
                            project["faFiles"][editSVGId]["svg"] = currentGraphEdit.getSvgCode();
                            $( '#editSVGDialog' ).dialog( "close" );
                        }
                    }, {
                        "text" : languageDicts[language]["dict"]["buttonCancel"],
                        "class" : "dialogCancelButton",
                        "click" : function() {
                            $( '#editSVGDialog' ).dialog( "close" );
                        }
                    }
                ],
                hide: {
                    effect: "explode",
                    duration: 1000
                }                
            });
            $( "#shortcutConfigurationWarningDialog" ).dialog({
                modal: true,
                autoOpen: false,
                buttons: [{
                    "text" : languageDicts[language]["dict"]["buttonOk"],
                    "class" : "dialogOkButton",
                    "click" : function() {
                        $( this ).dialog( "close" );
                    }
                }],
                open: function() {
                    $(".dialogOkButton").text(languageDicts[language]["dict"]["buttonOk"]);
                },
                hide: {
                    effect: "explode",
                    duration: 1000
                }
            });
            $( "#genericInfoDialog" ).dialog({
                modal: true,
                autoOpen: false,
                height: 400,
                width: 750,
                buttons: [{
                    "text" : languageDicts[language]["dict"]["buttonOk"],
                    "class" : "dialogOkButton",
                    "click" : function() {
                        $( this ).dialog( "close" );
                    }
                }],
                open: function() {
                    $(".dialogOkButton").text(languageDicts[language]["dict"]["buttonOk"]);
                },
                hide: {
                    effect: "explode",
                    duration: 1000
                }
            });
            $( "#shortcutConfigurationDialog" ).dialog({
                autoOpen: false,
                height: 400,
                width: 750,
                modal: true,
                open: function() {
                    // set text
                    $(this).dialog('option', 'title', languageDicts[language]["dict"]["configureShortcuts.label"]);
                    $(".dialogSaveButton").text(languageDicts[language]["dict"]["buttonSave"]);
                    $(".dialogCancelButton").text(languageDicts[language]["dict"]["buttonCancel"]);
                    $("#availableActionsAutoComplete").attr("placeholder", languageDicts[language]["dict"]["searchbarplaceholdertext"]);
                    // set content
                    var html = "<table class='dataContentTable'><tr class='header'><td class='label left' lid='shortcutAction.label'></td><td class='label right' lid='shortcutValue.label'></td></tr>";
                    var counter = 0;
                    var availableActions = new Array();
                    for(var actionNr=0; actionNr < shortcuts["actions"].length; actionNr++) {
                        var action = shortcuts["actions"][actionNr];
                        availableActions.push(action);
                        html += "<tr id='shortcut" + action + "tr' class='" + ((counter % 2 == 0) ? "even" : "odd") +"'><td><a name='shortcut" + action + "anchor'></a><span class='label' lid='" + action + ".label'></span></td><td align='right'><input id='shortcut" + action + "edit' type='text' value='-' style='text-align: right;'></td></tr>";
                        counter++;
                    }
                    html += "</table>";
                    $("#shortcutConfigurationDialogContent").html(html);
                    for(key in shortcuts) {
                        if(key.startsWith("_")) {
                            var value = shortcuts[key];
                            key = key.substr(1);
                            var ele = document.getElementById("shortcut" + value + "edit");
                            if(ele != null) {
                                ele.value = key;
                                $(ele).attr("placeholder", key);
                                counter++;
                            }
                        }
                    }
                    // damn autocomplete
                    var control = $( "#availableActionsAutoComplete" );
                    control.autocomplete({
                        source: availableActions,
                        select: function(event, ui) {
                            jump("shortcut" + ui.item.value + "anchor");
                            javascript:$("#shortcut" + ui.item.value + "tr").effect('highlight', {color: 'red'}, 1750);
                        }
                    });
                    control.focus(function(){$(this).val('');});
                    setLanguage(language);
                },
                buttons: [{
                        "text" : languageDicts[language]["dict"]["buttonSave"],
                        "class" : "dialogSaveButton",
                        "click" : function() {
                            var newShortcuts = getNewShortcuts();
                            if(newShortcuts != null) {
                                shortcuts = newShortcuts;
                                $( "#shortcutConfigurationDialog" ).dialog("close");
                            }
                        }
                    }, {
                        "text" : languageDicts[language]["dict"]["buttonCancel"],
                        "class" : "dialogCancelButton",
                        "click" : function() {
                            $( "#shortcutConfigurationDialog" ).dialog("close");
                        }
                    }
                ],
                hide: {
                    effect: "explode",
                    duration: 1000
                }
            });
            // do shortcut handling
            $("body").keydown(function(event) {
                var fobj = $(':focus');
                if(!fobj.is("input") && !fobj.is("textarea")) {
                    var mod = "_";
                    if(event.ctrlKey)  mod = mod + "c";
                    if(event.altKey)   mod = mod + "a";
                    if(event.shiftKey) mod = mod + "s";
                    mod = mod + event.keyCode;
                    console.log("INFO: pressed '" + mod + "'!");
                    if(typeof shortcuts[mod] != "undefined") {
                        console.log("INFO: exec '" + shortcuts[mod] + "'!");
                        handleEvent(shortcuts[mod]);
                        event.preventDefault();
                    }
                }
            });
            // everything done -> remove overlay
            $("#calculationOverlay").hide();
        </script>
    </body>
</html>
